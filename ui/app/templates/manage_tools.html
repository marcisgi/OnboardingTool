{% extends "base.html" %}
{% block content %}
<section class="space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-semibold">Manage Tools</h2>
      <p class="text-sm text-slate-500">Add and edit tools in the catalog</p>
    </div>
    <button class="rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white">+ Add Tool</button>
  </div>

  <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
    <div class="relative">
      <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M12.9 14.32a7 7 0 1 1 1.414-1.414l3.387 3.387a1 1 0 0 1-1.414 1.414l-3.387-3.387ZM14 8a6 6 0 1 0-12 0 6 6 0 0 0 12 0Z" clip-rule="evenodd" />
        </svg>
      </span>
      <input placeholder="Search tools..." class="w-full rounded-xl border border-slate-200 bg-white px-9 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900" />
    </div>
  </div>

  <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
    <div class="grid grid-cols-[2fr_1fr_1fr_1fr_auto] gap-4 border-b border-slate-200 pb-3 text-xs font-semibold uppercase text-slate-500">
      <div>Tool</div>
      <div>Category</div>
      <div>Status</div>
      <div>Experts</div>
      <div class="text-right">Actions</div>
    </div>
    <div class="divide-y divide-slate-100">
      {% for tool in tools %}
      <div class="grid grid-cols-[2fr_1fr_1fr_1fr_auto] gap-4 py-4 text-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-slate-100">
            {% if tool.has_logo %}
            <img src="/logos/{{ tool.id }}" alt="{{ tool.title }} logo" class="h-8 w-8 object-contain" />
            {% else %}
            <span class="text-xs font-semibold text-slate-600">{{ tool.title[:2] }}</span>
            {% endif %}
          </div>
          <div>
            <p class="font-semibold">{{ tool.title }}</p>
            <p class="text-xs text-slate-500">{{ tool.description or "" }}</p>
          </div>
        </div>
        <div>
          <span class="rounded-full border border-slate-200 px-2 py-1 text-xs">{{ tool.category }}</span>
        </div>
        <div>
          {% if tool.status == "Active" %}
          <span class="rounded-full bg-emerald-100 px-2 py-1 text-xs text-emerald-700">Active</span>
          {% elif tool.status == "Planned" %}
          <span class="rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-700">Planned</span>
          {% else %}
          <span class="rounded-full bg-amber-100 px-2 py-1 text-xs text-amber-700">Deprecated</span>
          {% endif %}
        </div>
        <div class="text-xs text-slate-500">
          {{ tool.experts | length }} expert{% if tool.experts | length != 1 %}s{% endif %}
        </div>
        <div class="flex items-center justify-end gap-3 text-xs">
          <a class="text-slate-500 hover:text-slate-800" href="/tools/{{ tool.id }}">Edit</a>
          <form method="post" action="/manage/tools/{{ tool.id }}/delete">
            <button class="text-rose-500 hover:text-rose-600" type="submit">Delete</button>
          </form>
        </div>
      </div>
      {% else %}
      <p class="py-6 text-sm text-slate-500">No tools created yet.</p>
      {% endfor %}
    </div>
  </div>

  <div class="grid gap-8 lg:grid-cols-[1.2fr_1fr]">
    <div class="rounded-3xl border border-slate-200 bg-white/80 p-6 shadow-lg shadow-slate-200/40 dark:border-slate-800 dark:bg-slate-900/70 dark:shadow-none">
      <h2 class="text-lg font-semibold">Create Tool</h2>
      {% if error %}
      <div class="mt-3 rounded-xl border border-rose-200 bg-rose-50 px-4 py-2 text-sm text-rose-700">
        {{ error }}
      </div>
      {% endif %}
      <form class="mt-4 grid gap-4" method="post" action="/manage/tools">
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Title</label>
          <input name="title" value="{{ form_values.title or '' }}" required class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900" />
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Category</label>
          <input name="category" value="{{ form_values.category or '' }}" required class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900" />
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Description (rich text allowed)</label>
          <textarea name="description" rows="4" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900">{{ form_values.description or '' }}</textarea>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Tags (comma-separated)</label>
            <input name="tags" value="{{ form_values.tags or '' }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900" />
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Status</label>
            <select name="status" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900">
              <option {% if form_values.status == "Active" %}selected{% endif %}>Active</option>
              <option {% if form_values.status == "Deprecated" %}selected{% endif %}>Deprecated</option>
              <option {% if form_values.status == "Planned" %}selected{% endif %}>Planned</option>
            </select>
          </div>
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Owner Team</label>
          <select id="ownerTeamSelect" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900">
            <option value="">Select team</option>
            {% for team in teams %}
            <option value="{{ team.id }}">{{ team.name }}</option>
            {% endfor %}
          </select>
          <input type="hidden" name="owner_teams" id="ownerTeamsInput" value="{{ form_values.owner_teams or '' }}" />
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Access Owner (select member)</label>
            <select id="accessOwner" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900">
              <option value="">Select a team member</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Access Process</label>
            <input name="access_process" value="{{ form_values.access_process or '' }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900" />
          </div>
        </div>
        <input type="hidden" name="access_owner_name" id="accessOwnerName" />
        <input type="hidden" name="access_owner_email" id="accessOwnerEmail" />
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Experts (name | email | title | backup)</label>
          <textarea name="experts" rows="3" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900">{{ form_values.experts or '' }}</textarea>
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Documentation Links (title | url | type)</label>
          <textarea name="documentation_links" rows="3" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900">{{ form_values.documentation_links or '' }}</textarea>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Tool URL</label>
            <input name="tool_url" value="{{ form_values.tool_url or '' }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900" />
          </div>
          <div class="grid gap-2">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Sort Order</label>
            <input name="sort_order" type="number" value="{{ form_values.sort_order or 0 }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm shadow-sm dark:border-slate-700 dark:bg-slate-900" />
            <label class="flex items-center gap-2 text-xs text-slate-500">
              <input type="checkbox" name="is_featured" class="rounded border-slate-300" {% if form_values.is_featured %}checked{% endif %} />
              Featured
            </label>
          </div>
        </div>
        <button class="rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-600/30 hover:bg-indigo-700" type="submit">Create Tool</button>
      </form>
    </div>

    <div class="rounded-3xl border border-slate-200 bg-white/80 p-6 shadow-lg shadow-slate-200/40 dark:border-slate-800 dark:bg-slate-900/70 dark:shadow-none">
      <h2 class="text-lg font-semibold">Existing Tools</h2>
      <div class="mt-4 space-y-4">
        {% for tool in tools %}
        <div class="rounded-2xl border border-slate-200 bg-white/90 p-4 text-sm shadow-sm dark:border-slate-800 dark:bg-slate-900/80">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-semibold">{{ tool.title }}</p>
              <p class="text-xs text-slate-500">{{ tool.category }} â€¢ {{ tool.status }}</p>
            </div>
            <div class="flex items-center gap-3">
              <form method="post" action="/manage/tools/{{ tool.id }}/delete">
                <button class="text-xs font-semibold text-rose-500 hover:text-rose-600" type="submit">Delete</button>
              </form>
            </div>
          </div>
          <details class="mt-3 rounded-xl border border-slate-200 bg-white/60 p-3 dark:border-slate-800 dark:bg-slate-900/70">
            <summary class="cursor-pointer text-xs font-semibold uppercase tracking-wide text-slate-500">Edit Tool</summary>
            <form class="mt-3 grid gap-3 text-xs" method="post" action="/manage/tools/{{ tool.id }}/edit">
              <input name="title" value="{{ tool.title }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900" />
              <input name="category" value="{{ tool.category }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900" />
              <textarea name="description" rows="3" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900">{{ tool.description or '' }}</textarea>
              <input name="tags" value="{{ tool.tags | join(', ') }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900" />
              <input name="owner_teams" value="{{ tool.owner_teams | join(', ') }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900" />
              <input name="access_owner_name" value="{{ tool.access_owner_name or '' }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900" />
              <input name="access_owner_email" value="{{ tool.access_owner_email or '' }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900" />
              <input name="access_process" value="{{ tool.access_process or '' }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900" />
              <input name="tool_url" value="{{ tool.tool_url or '' }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900" />
              <textarea name="experts" rows="3" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900">{% for expert in tool.experts %}{{ expert.name }} | {{ expert.email }} | {{ expert.title or '' }} | {{ 'backup' if expert.is_backup else '' }}{% if not loop.last %}&#10;{% endif %}{% endfor %}</textarea>
              <textarea name="documentation_links" rows="3" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900">{% for link in tool.documentation_links %}{{ link.title }} | {{ link.url }} | {{ link.type or '' }}{% if not loop.last %}&#10;{% endif %}{% endfor %}</textarea>
              <div class="grid gap-2 md:grid-cols-2">
                <select name="status" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900">
                  <option value="Active" {% if tool.status == "Active" %}selected{% endif %}>Active</option>
                  <option value="Deprecated" {% if tool.status == "Deprecated" %}selected{% endif %}>Deprecated</option>
                  <option value="Planned" {% if tool.status == "Planned" %}selected{% endif %}>Planned</option>
                </select>
                <input name="sort_order" type="number" value="{{ tool.sort_order or 0 }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-700 dark:bg-slate-900" />
              </div>
              <label class="flex items-center gap-2 text-xs text-slate-500">
                <input type="checkbox" name="is_featured" {% if tool.is_featured %}checked{% endif %} />
                Featured
              </label>
              <button class="rounded-xl bg-slate-900 px-3 py-1 text-xs font-semibold text-white dark:bg-slate-700" type="submit">Save</button>
            </form>
          </details>
          <div class="mt-3 grid gap-2">
            <form method="post" action="/manage/tools/{{ tool.id }}/logo/upload" enctype="multipart/form-data">
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Upload Logo</label>
              <div class="mt-1 flex gap-2">
                <input type="file" name="logo_file" accept="image/*" class="text-xs text-slate-500" />
                <button class="rounded-xl bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600 dark:bg-slate-800 dark:text-slate-200" type="submit">Upload</button>
              </div>
            </form>
            <form method="post" action="/manage/tools/{{ tool.id }}/logo/import">
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Import Logo URL</label>
              <div class="mt-1 flex gap-2">
                <input name="logo_url" placeholder="https://" class="flex-1 rounded-xl border border-slate-200 px-3 py-1 text-xs dark:border-slate-700 dark:bg-slate-900" />
                <button class="rounded-xl bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600 dark:bg-slate-800 dark:text-slate-200" type="submit">Fetch</button>
              </div>
            </form>
          </div>
        </div>
        {% else %}
        <p class="text-sm text-slate-500">No tools created yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</section>
<script>
  const teams = {{ teams | tojson }};
  const accessOwner = document.getElementById("accessOwner");
  const ownerTeamSelect = document.getElementById("ownerTeamSelect");
  const ownerTeamsInput = document.getElementById("ownerTeamsInput");
  const ownerName = document.getElementById("accessOwnerName");
  const ownerEmail = document.getElementById("accessOwnerEmail");

  const renderMembers = (teamId) => {
    accessOwner.innerHTML = '<option value="">Select a team member</option>';
    const team = teams.find((entry) => String(entry.id) === String(teamId));
    if (!team) {
      return;
    }
    (team.members || []).forEach((member) => {
      const option = document.createElement("option");
      option.value = member.email;
      option.textContent = `${member.name} (${member.email})`;
      option.dataset.name = member.name;
      accessOwner.appendChild(option);
    });
  };

  ownerTeamSelect.addEventListener("change", (event) => {
    ownerTeamsInput.value = event.target.value ? `${event.target.value}` : "";
    renderMembers(event.target.value);
  });

  if (ownerTeamsInput.value) {
    ownerTeamSelect.value = ownerTeamsInput.value;
    renderMembers(ownerTeamsInput.value);
  }

  accessOwner.addEventListener("change", (event) => {
    const selected = event.target.selectedOptions[0];
    if (!selected) {
      ownerName.value = "";
      ownerEmail.value = "";
      return;
    }
    ownerName.value = selected.dataset.name || "";
    ownerEmail.value = selected.value || "";
  });
</script>
{% endblock %}
