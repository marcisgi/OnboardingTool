{% extends "base.html" %}
{% block content %}
<section class="mx-auto w-full max-w-6xl px-6 py-8">
  <div class="grid gap-8 lg:grid-cols-[1.2fr_1fr]">
    <div class="rounded-2xl bg-white p-6 shadow-sm dark:bg-slate-800">
      <h2 class="text-lg font-semibold">Create Tool</h2>
      <form class="mt-4 grid gap-4" method="post" action="/manage/tools">
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Title</label>
          <input name="title" required class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900" />
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Category</label>
          <input name="category" required class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900" />
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Description (rich text allowed)</label>
          <textarea name="description" rows="4" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900"></textarea>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Tags (comma-separated)</label>
            <input name="tags" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900" />
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Status</label>
            <select name="status" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900">
              <option>Active</option>
              <option>Deprecated</option>
              <option>Planned</option>
            </select>
          </div>
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Owner Team</label>
          <select id="ownerTeamSelect" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900">
            <option value="">Select team</option>
            {% for team in teams %}
            <option value="{{ team.id }}">{{ team.name }}</option>
            {% endfor %}
          </select>
          <input type="hidden" name="owner_teams" id="ownerTeamsInput" />
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Access Owner (select member)</label>
            <select id="accessOwner" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900">
              <option value="">Select a team member</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Access Process</label>
            <input name="access_process" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900" />
          </div>
        </div>
        <input type="hidden" name="access_owner_name" id="accessOwnerName" />
        <input type="hidden" name="access_owner_email" id="accessOwnerEmail" />
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Tool URL</label>
            <input name="tool_url" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900" />
          </div>
          <div class="grid gap-2">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Sort Order</label>
            <input name="sort_order" type="number" value="0" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-600 dark:bg-slate-900" />
            <label class="flex items-center gap-2 text-xs text-slate-500">
              <input type="checkbox" name="is_featured" class="rounded border-slate-300" />
              Featured
            </label>
          </div>
        </div>
        <button class="rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-700" type="submit">Create Tool</button>
      </form>
    </div>

    <div class="rounded-2xl bg-white p-6 shadow-sm dark:bg-slate-800">
      <h2 class="text-lg font-semibold">Existing Tools</h2>
      <div class="mt-4 space-y-4">
        {% for tool in tools %}
        <div class="rounded-xl border border-slate-200 p-4 text-sm dark:border-slate-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-semibold">{{ tool.title }}</p>
              <p class="text-xs text-slate-500">{{ tool.category }} â€¢ {{ tool.status }}</p>
            </div>
            <div class="flex items-center gap-3">
              <form method="post" action="/manage/tools/{{ tool.id }}/delete">
                <button class="text-xs font-semibold text-rose-500 hover:text-rose-600" type="submit">Delete</button>
              </form>
            </div>
          </div>
          <details class="mt-3 rounded-lg border border-slate-200 p-3 dark:border-slate-700">
            <summary class="cursor-pointer text-xs font-semibold uppercase tracking-wide text-slate-500">Edit Tool</summary>
            <form class="mt-3 grid gap-3 text-xs" method="post" action="/manage/tools/{{ tool.id }}/edit">
              <input name="title" value="{{ tool.title }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900" />
              <input name="category" value="{{ tool.category }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900" />
              <textarea name="description" rows="3" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900">{{ tool.description or '' }}</textarea>
              <input name="tags" value="{{ tool.tags | join(', ') }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900" />
              <input name="owner_teams" value="{{ tool.owner_teams | join(', ') }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900" />
              <input name="access_owner_name" value="{{ tool.access_owner_name or '' }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900" />
              <input name="access_owner_email" value="{{ tool.access_owner_email or '' }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900" />
              <input name="access_process" value="{{ tool.access_process or '' }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900" />
              <input name="tool_url" value="{{ tool.tool_url or '' }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900" />
              <div class="grid gap-2 md:grid-cols-2">
                <select name="status" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900">
                  <option value="Active" {% if tool.status == "Active" %}selected{% endif %}>Active</option>
                  <option value="Deprecated" {% if tool.status == "Deprecated" %}selected{% endif %}>Deprecated</option>
                  <option value="Planned" {% if tool.status == "Planned" %}selected{% endif %}>Planned</option>
                </select>
                <input name="sort_order" type="number" value="{{ tool.sort_order or 0 }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 dark:border-slate-600 dark:bg-slate-900" />
              </div>
              <label class="flex items-center gap-2 text-xs text-slate-500">
                <input type="checkbox" name="is_featured" {% if tool.is_featured %}checked{% endif %} />
                Featured
              </label>
              <button class="rounded-lg bg-slate-900 px-3 py-1 text-xs font-semibold text-white dark:bg-slate-700" type="submit">Save</button>
            </form>
          </details>
          <div class="mt-3 grid gap-2">
            <form method="post" action="/manage/tools/{{ tool.id }}/logo/upload" enctype="multipart/form-data">
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Upload Logo</label>
              <div class="mt-1 flex gap-2">
                <input type="file" name="logo_file" accept="image/*" class="text-xs text-slate-500" />
                <button class="rounded-lg bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600" type="submit">Upload</button>
              </div>
            </form>
            <form method="post" action="/manage/tools/{{ tool.id }}/logo/import">
              <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">Import Logo URL</label>
              <div class="mt-1 flex gap-2">
                <input name="logo_url" placeholder="https://" class="flex-1 rounded-lg border border-slate-200 px-3 py-1 text-xs dark:border-slate-600 dark:bg-slate-900" />
                <button class="rounded-lg bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600" type="submit">Fetch</button>
              </div>
            </form>
          </div>
        </div>
        {% else %}
        <p class="text-sm text-slate-500">No tools created yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</section>
<script>
  const teams = {{ teams | tojson }};
  const accessOwner = document.getElementById("accessOwner");
  const ownerTeamSelect = document.getElementById("ownerTeamSelect");
  const ownerTeamsInput = document.getElementById("ownerTeamsInput");
  const ownerName = document.getElementById("accessOwnerName");
  const ownerEmail = document.getElementById("accessOwnerEmail");

  const renderMembers = (teamId) => {
    accessOwner.innerHTML = '<option value="">Select a team member</option>';
    const team = teams.find((entry) => String(entry.id) === String(teamId));
    if (!team) {
      return;
    }
    (team.members || []).forEach((member) => {
      const option = document.createElement("option");
      option.value = member.email;
      option.textContent = `${member.name} (${member.email})`;
      option.dataset.name = member.name;
      accessOwner.appendChild(option);
    });
  };

  ownerTeamSelect.addEventListener("change", (event) => {
    ownerTeamsInput.value = event.target.value ? `${event.target.value}` : "";
    renderMembers(event.target.value);
  });

  accessOwner.addEventListener("change", (event) => {
    const selected = event.target.selectedOptions[0];
    if (!selected) {
      ownerName.value = "";
      ownerEmail.value = "";
      return;
    }
    ownerName.value = selected.dataset.name || "";
    ownerEmail.value = selected.value || "";
  });
</script>
{% endblock %}
